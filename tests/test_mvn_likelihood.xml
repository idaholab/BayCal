<?xml version="1.0" ?>
<Simulation verbosity="silent">
  <TestInfo>
    <name>mvn_likelihood</name>
    <author>wangc</author>
    <created>2020-07-20</created>
    <classesTested>ExternalModelPluginBase.LikelihoodModel</classesTested>
    <description>
      Test the Markov Chain Monte Carlo algorithm with multivariate normal likelihood function
    </description>
  </TestInfo>

  <RunInfo>
    <WorkingDir>mvn_likelihood</WorkingDir>
    <Sequence>mh, print</Sequence>
    <batchSize>1</batchSize>
    <internalParallel>False</internalParallel>
  </RunInfo>

  <Files>
    <Input name="simInput" type="">model.i</Input>
    <Input name="simMesh" type="">model.e</Input>
  </Files>

  <Distributions>
    <Normal name="normal">
      <mean>0</mean>
      <sigma>1</sigma>
    </Normal>
  </Distributions>

  <Samplers>
    <Metropolis name="Metropolis">
      <samplerInit>
        <limit>1000</limit>
        <initialSeed>070419</initialSeed>
        <burnIn>10</burnIn>
      </samplerInit>
      <likelihood log="True">likelihood</likelihood>
      <variable name="xin">
        <distribution>normal</distribution>
        <initial>0</initial>
        <proposal class="Distributions" type="Normal">normal</proposal>
      </variable>
      <variable name="yin">
        <distribution>normal</distribution>
        <initial>0</initial>
        <proposal class="Distributions" type="Normal">normal</proposal>
        <!-- <proposal>normal</proposal> -->
      </variable>
      <TargetEvaluation class="DataObjects" type="PointSet">outSet</TargetEvaluation>
    </Metropolis>
  </Samplers>

  <Models>
    <ExternalModel name="likelihood" subType="BayCal.LikelihoodModel">
      <variables>likelihood</variables>
      <LikelihoodModel type="normal">
        <simTargets>zout</simTargets> <!-- targets of interest from simulation -->
        <expTargets shape="" computeCov='True' correlation='False'></expTargets>
        <expCov diag="False"></expCov>
        <!--
        <biasTargets></biasTargets>
        <biasCov diag="False"></biasCov>
        <romCov diag="False"></romCov>
         -->
      </LikelihoodModel>
    </ExternalModel>
    <!-- Code -->
    <Code name="simModel" subType="MooseBasedApp">
      <executable>%FRAMEWORK_DIR%/../../moose/modules/combined/modules-%METHOD%</executable>
      <alias variable="k" type="input">Materials|thermal|thermal_conductivity</alias>
      <alias variable="" type="input"></alias>
    </Code>
    <!-- EnsembleModel -->
    <EnsembleModel name="EnsembleLH" subType="">
      <Model class="Models" type="Code">
          simModel
        <Input class="Files" type="">simInput</Input>
        <Input class="Files" type="">simMesh</Input>
        <TargetEvaluation class="DataObjects" type="PointSet">simData</TargetEvaluation>
      </Model>
      <Model class="Models" type="ExternalModel">
          likelihood
        <Input class="DataObjects" type="PointSet">inputHolder</Input>
        <TargetEvaluation class="DataObjects" type="PointSet">lhData</TargetEvaluation>
      </Model>
    </EnsembleModel>
  </Models>

  <Steps>
    <MultiRun name="BayesianInference">
      <Input class="Files" type="">simInput</Input>
      <Input class="Files" type="">simMesh</Input>
      <Input class="DataObjects" type="PointSet">inputHolder</Input>
      <Model class="Models" type="EnsembleModel">EnsembleLH</Model>
      <Sampler class="Samplers" type="Metropolis">Metropolis</Sampler>
      <SolutionExport class="DataObjects" type="PointSet">out_export</SolutionExport>
      <Output class="DataObjects" type="PointSet">outSet</Output>
    </MultiRun>
    <IOStep name="print">
      <Input class="DataObjects" type="PointSet">out_export</Input>
      <Input class="DataObjects" type="PointSet">outSet</Input>
      <Output class="OutStreams" type="Print">dumpExport</Output>
      <Output class="OutStreams" type="Print">dumpOut</Output>
    </IOStep>
  </Steps>

  <OutStreams>
    <Print name="dumpOut">
      <type>csv</type>
      <source>outSet</source>
      <what>input, output</what>
    </Print>
    <Print name="dumpExport">
      <type>csv</type>
      <source>out_export</source>
      <what>input, output</what>
    </Print>
  </OutStreams>

  <DataObjects>
    <PointSet name="inputHolder">
      <Input>xin, yin</Input>
      <Output>OutputPlaceHolder</Output>
    </PointSet>

    <PointSet name="outSet">
      <Input>xin, yin</Input>
      <Output>zout</Output>
    </PointSet>

    <PointSet name="out_export">
      <Input>traceID</Input>
      <Output>xin, yin</Output>
    </PointSet>
  </DataObjects>

  <PointSet name="simData">
    <!-- calibrated parameters -->
    <Input>xin, yin</Input>
    <!-- simulation targets that will be passed to likelihood model -->
    <Output>zout</Output>
  </PointSet>

  <PointSet name="lhData">
    <!-- simulation targets -->
    <Input>zout</Input>
    <Output>likelihood</Output>
  </PointSet>
</Simulation>
